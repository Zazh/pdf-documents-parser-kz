{% extends 'base.html' %}

{% block title %}–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</h4>
            </div>
            <div class="card-body">
                <div id="imageContainer" style="position: relative; display: inline-block; max-width: 100%;">
                    <p class="text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ JPG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</p>
                </div>

                <div id="coordinateForm" style="display: none;">
                    <h6 class="mt-3">–û–±–ª–∞—Å—Ç–∏ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:</h6>
                    <div class="row">
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="startSelection('last_name')">
                                üìù –§–∞–º–∏–ª–∏—è
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-success btn-sm w-100 mb-2" onclick="startSelection('first_name')">
                                üë§ –ò–º—è
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-info btn-sm w-100 mb-2" onclick="startSelection('patronymic')">
                                üë® –û—Ç—á–µ—Å—Ç–≤–æ
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="startSelection('birth_date')">
                                üéÇ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="startSelection('iin')">
                                üî¢ –ò–ò–ù
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="startSelection('photo')">
                                üì∑ –§–æ—Ç–æ
                            </button>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-purple btn-sm w-100 mb-2" onclick="startSelection('birth_place')" style="background-color: #6f42c1; color: white;">
                                üèôÔ∏è –ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-teal btn-sm w-100 mb-2" onclick="startSelection('nationality')" style="background-color: #20c997; color: white;">
                                üåç –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-orange btn-sm w-100 mb-2" onclick="startSelection('document_number')" style="background-color: #fd7e14; color: white;">
                                üìÑ –ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-pink btn-sm w-100 mb-2" onclick="startSelection('issued_by')" style="background-color: #e83e8c; color: white;">
                                üèõÔ∏è –ö–µ–º –≤—ã–¥–∞–Ω
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-lime btn-sm w-100 mb-2" onclick="startSelection('issue_date')" style="background-color: #32cd32; color: white;">
                                üìÖ –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-coral btn-sm w-100 mb-2" onclick="startSelection('expiry_date')" style="background-color: #ff6347; color: white;">
                                ‚è∞ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                            </button>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6>–¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</h6>
                        <div id="coordinatesList" class="small"></div>
                    </div>

                    <div class="mt-3">
                        <button type="button" id="saveCoords" class="btn btn-primary">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                        </button>
                        <button type="button" id="testCoords" class="btn btn-success">
                            üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
                        </button>
                        <button type="button" id="resetCoords" class="btn btn-outline-secondary">
                            üîÑ –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h6>
            </div>
            <div class="card-body">
                <ol>
                    <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JPG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω—É–∂–Ω–æ–≥–æ –ø–æ–ª—è</li>
                    <li>–í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏</li>
                    <li>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –≤—Å–µ—Ö 12 –ø–æ–ª–µ–π</li>
                    <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</li>
                </ol>

                <div class="mt-3">
                    <label for="imageFile" class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
                    <input type="file" id="imageFile" accept=".jpg,.jpeg,.png" class="form-control">
                    <button type="button" id="loadImage" class="btn btn-outline-primary mt-2 w-100">
                        üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        üí° <strong>–°–æ–≤–µ—Ç:</strong> –î–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–µ—Ç–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Ö–æ—Ä–æ—à–µ–º –∫–∞—á–µ—Å—Ç–≤–µ.
                    </small>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h6>
            </div>
            <div class="card-body">
                <div id="testResult">
                    <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å"</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.selection-box {
    position: absolute;
    border: 3px solid;
    background-color: rgba(0, 123, 255, 0.2);
    cursor: move;
    border-radius: 4px;
}

.selection-box.last_name { border-color: #007bff; }
.selection-box.first_name { border-color: #28a745; }
.selection-box.iin { border-color: #ffc107; }
.selection-box.photo { border-color: #17a2b8; }

.selection-label {
    position: absolute;
    top: -25px;
    left: 0;
    color: white;
    padding: 2px 8px;
    font-size: 12px;
    border-radius: 3px;
    font-weight: bold;
}

.selection-label.last_name { background: #007bff; }
.selection-label.first_name { background: #28a745; }
.selection-label.iin { background: #ffc107; color: #000; }
.selection-label.photo { background: #17a2b8; }

#loadedImage {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.coordinate-item {
    padding: 5px;
    margin: 2px 0;
    border-radius: 3px;
    font-family: monospace;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageContainer = document.getElementById('imageContainer');
    const coordinateForm = document.getElementById('coordinateForm');
    let loadedImage = null;
    let isSelecting = false;
    let currentField = null;
    let startX = 0, startY = 0;

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    let selections = {
        last_name: null,
        first_name: null,
        patronymic: null,
        birth_date: null,
        iin: null,
        birth_place: null,
        nationality: null,
        document_number: null,
        issued_by: null,
        issue_date: null,
        expiry_date: null,
        photo: null
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('loadImage').addEventListener('click', function() {
        const fileInput = document.getElementById('imageFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            loadImage(e.target.result);
        };
        reader.readAsDataURL(file);
    });

    function loadImage(src) {
        imageContainer.innerHTML = `
            <img id="loadedImage" src="${src}" alt="–î–æ–∫—É–º–µ–Ω—Ç">
        `;

        loadedImage = document.getElementById('loadedImage');
        coordinateForm.style.display = 'block';

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        setupImageEvents();
    }

    function setupImageEvents() {
        loadedImage.addEventListener('mousedown', startSelection);
        loadedImage.addEventListener('mousemove', updateSelection);
        loadedImage.addEventListener('mouseup', endSelection);
        loadedImage.style.userSelect = 'none';
    }

    window.startSelection = function(fieldType) {
        currentField = fieldType;
        loadedImage.style.cursor = 'crosshair';

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('button[onclick^="startSelection"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        alert(`–í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø–æ–ª—è "${getFieldName(fieldType)}" –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏`);
    };

    function startSelection(e) {
        if (!currentField) return;

        e.preventDefault();
        isSelecting = true;

        const rect = loadedImage.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
    }

    function updateSelection(e) {
        if (!isSelecting || !currentField) return;

        e.preventDefault();
        const rect = loadedImage.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;

        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        const tempBox = document.querySelector('.temp-selection');
        if (tempBox) tempBox.remove();

        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        const box = createSelectionBox(
            Math.min(startX, currentX),
            Math.min(startY, currentY),
            Math.abs(currentX - startX),
            Math.abs(currentY - startY),
            currentField,
            true
        );

        imageContainer.appendChild(box);
    }

    function endSelection(e) {
        if (!isSelecting || !currentField) return;

        e.preventDefault();
        isSelecting = false;
        loadedImage.style.cursor = 'default';

        const rect = loadedImage.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;

        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        const tempBox = document.querySelector('.temp-selection');
        if (tempBox) tempBox.remove();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        const imageWidth = loadedImage.clientWidth;
        const imageHeight = loadedImage.clientHeight;

        const left = Math.min(startX, endX) / imageWidth;
        const top = Math.min(startY, endY) / imageHeight;
        const right = Math.max(startX, endX) / imageWidth;
        const bottom = Math.max(startY, endY) / imageHeight;

        selections[currentField] = [left, top, right, bottom];

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—è
        const oldBox = document.querySelector(`.selection-box.${currentField}`);
        if (oldBox) oldBox.remove();

        // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        const box = createSelectionBox(
            left * imageWidth,
            top * imageHeight,
            (right - left) * imageWidth,
            (bottom - top) * imageHeight,
            currentField,
            false
        );

        imageContainer.appendChild(box);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        updateCoordinatesList();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
        currentField = null;
        document.querySelectorAll('button[onclick^="startSelection"]').forEach(btn => {
            btn.classList.remove('active');
        });
    }

    function createSelectionBox(x, y, width, height, fieldType, isTemp) {
        const box = document.createElement('div');
        box.className = `selection-box ${fieldType} ${isTemp ? 'temp-selection' : ''}`;
        box.style.left = x + 'px';
        box.style.top = y + 'px';
        box.style.width = width + 'px';
        box.style.height = height + 'px';

        if (!isTemp) {
            const label = document.createElement('div');
            label.className = `selection-label ${fieldType}`;
            label.textContent = getFieldName(fieldType);
            box.appendChild(label);
        }

        return box;
    }

    function getFieldName(fieldType) {
        const names = {
            last_name: '–§–∞–º–∏–ª–∏—è',
            first_name: '–ò–º—è',
            patronymic: '–û—Ç—á–µ—Å—Ç–≤–æ',
            birth_date: '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è',
            iin: '–ò–ò–ù',
            birth_place: '–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è',
            nationality: '–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å',
            document_number: '–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞',
            issued_by: '–ö–µ–º –≤—ã–¥–∞–Ω',
            issue_date: '–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏',
            expiry_date: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
            photo: '–§–æ—Ç–æ'
        };
        return names[fieldType] || fieldType;
    }

    function updateCoordinatesList() {
        const list = document.getElementById('coordinatesList');
        let html = '';

        for (const [field, coords] of Object.entries(selections)) {
            if (coords) {
                const [left, top, right, bottom] = coords;
                html += `
                    <div class="coordinate-item" style="background-color: #f8f9fa;">
                        <strong>${getFieldName(field)}:</strong>
                        ${(left*100).toFixed(1)}%, ${(top*100).toFixed(1)}%, ${(right*100).toFixed(1)}%, ${(bottom*100).toFixed(1)}%
                    </div>
                `;
            }
        }

        list.innerHTML = html || '<p class="text-muted">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</p>';
    }

    // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    document.getElementById('saveCoords').addEventListener('click', function() {
        if (Object.values(selections).every(coord => coord === null)) {
            alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/api/save-coordinates/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(selections)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –ø–∞—Ä—Å–µ—Ä –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.');
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç');
        });
    });

    document.getElementById('testCoords').addEventListener('click', function() {
        if (Object.values(selections).every(coord => coord === null)) {
            alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
            return;
        }

        document.getElementById('testResult').innerHTML = `
            <div class="alert alert-info">
                <strong>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç...</strong><br>
                –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è ${Object.values(selections).filter(c => c !== null).length} –ø–æ–ª–µ–π
            </div>
        `;
    });

    document.getElementById('resetCoords').addEventListener('click', function() {
        selections = {
            last_name: null,
            first_name: null,
            patronymic: null,
            birth_date: null,
            iin: null,
            birth_place: null,
            nationality: null,
            document_number: null,
            issued_by: null,
            issue_date: null,
            expiry_date: null,
            photo: null
        };
        document.querySelectorAll('.selection-box').forEach(box => box.remove());
        updateCoordinatesList();
    });
});
</script>
{% endblock %}